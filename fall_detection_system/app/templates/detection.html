{% extends 'base.html' %}
{% load static %}

{% block title %}跌倒检测{% endblock %}

{% block content %}
<style>
    .detection-container {
        display: flex;
        width: 100%;
        min-height: 80vh;
        padding: 2rem;
        gap: 2rem;
    }

    .controls-section {
        flex: 1;
        max-width: 300px;
    }

    .detection-icons {
        display: flex;
        gap: 20px;
        margin-bottom: 2rem;
    }

    .detection-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        padding: 15px;
        border-radius: 10px;
        transition: all 0.3s ease;
        width: 120px;  /* 固定宽度 */
    }

    .detection-icon:hover {
        background-color: rgba(0, 123, 255, 0.1);
        transform: translateY(-5px);
    }

    .detection-icon img {
        width: 50px;  /* 设置图标大小 */
        height: 50px;
        margin-bottom: 0.5rem;
        object-fit: contain;
    }

    .detection-icon span {
        font-size: 0.9rem;
        color: #333;
        text-align: center;
    }

    .result-container {
        flex: 2;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .upload-section {
        display: none;  /* 默认隐藏 */
        text-align: center;
        padding: 2rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 2rem;
        background-color: #f8f9fa;
    }

    .file-input {
        display: none;
    }

    .upload-btn {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 10px;
    }

    .upload-btn:hover {
        background-color: #0056b3;
    }

    .preview-section {
        margin-top: 0rem;
        text-align: center;
        width: 100%;
        max-width: 640px;
        margin-left: auto;
        margin-right: auto;
    }

    .preview-image, .preview-video {
        max-width: 640px;  /* 限制最大宽度 */
        max-height: 360px; /* 限制最大高度，保持16:9比例 */
        margin: 1rem auto;
        display: block;
    }

    .result-section {
        margin-top: 2rem;
        padding: 1rem;
        border-radius: 8px;
        background-color: #f8f9fa;
        width: 100%;
        max-width: 640px;
        margin-left: auto;
        margin-right: auto;
    }

    .loading {
        display: none;
        text-align: center;
        margin: 1rem 0;
    }

    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .message {
        padding: 10px;
        margin: 1rem 0;
        border-radius: 4px;
        text-align: center;
    }

    .message-error {
        background-color: #f8d7da;
        color: #721c24;
    }

    .message-success {
        background-color: #d4edda;
        color: #155724;
    }

    .progress {
        height: 20px;
        background-color: #f3f3f3;
        border-radius: 5px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background-color: #007bff;
        transition: width 0.3s ease;
    }

    /* 修改摄像头预览大小 */
    #webcam {
        max-width: 640px;
        max-height: 360px;
        margin: 0 auto;
        display: block;
    }

    /* 修改检测结果展示大小 */
    #resultContent img,
    #resultContent video {
        max-width: 640px;
        max-height: 360px;
        margin: 1rem auto;
        display: block;
    }

    /* 添加容器样式确保居中显示 */
    .preview-container,
    .result-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    /* 在 style 标签中添加这个样式 */
    .small.text-muted {
        font-size: 14px;  /* 可以调整这个数值来改变文字大小 */
        color: #6c757d;   /* 文字颜色 */
        margin-top: 8px;  /* 可以调整上边距 */
    }

    /* 在 style 标签中添加这个样式 */
    .format-hint {
        font-size: 15px;         /* 文字大小 */
        color: #6c757d;         /* 文字颜色 */
        margin: 20px 0;         /* 上下边距 */
        font-weight: normal;    /* 文字粗细 */
    }
</style>

<div class="detection-container">
    <div class="controls-section">
        <div class="detection-icons">
            <div class="detection-icon" onclick="activateCamera()">
                <img src="{% static 'images/camera-icon.png' %}" alt="摄像头检测">
                <span>摄像头检测</span>
            </div>
            <div class="detection-icon" onclick="activateVideoUpload()">
                <img src="{% static 'images/video-icon.png' %}" alt="视频检测">
                <span>视频检测</span>
            </div>
            <div class="detection-icon" onclick="activateImageUpload()">
                <img src="{% static 'images/image-icon.png' %}" alt="图片检测">
                <span>图片检测</span>
            </div>
        </div>

        <div id="uploadSection" class="upload-section">
            <form id="uploadForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="detection_type" id="detection_type" value="">
                <input type="file" id="fileInput" class="file-input" name="file" required>
                <button type="button" class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    选择文件
                </button>
                <p class="format-hint" id="formatHint"></p>
                <button type="button" class="upload-btn" onclick="startDetection()">开始检测</button>
            </form>
        </div>
    </div>

    <div class="result-container">
        <div id="cameraPreview" style="display: none;">
            <div style="width: 100%; max-width: 640px; margin: 0 auto;">
                <video id="webcam" autoplay playsinline></video>
            </div>
        </div>

        <div class="preview-section" id="previewSection" style="display: none;">
            <h3>预览</h3>
            <div class="preview-container">
                <img id="previewImage" class="preview-image" style="display: none;">
                <video id="previewVideo" class="preview-video" controls style="display: none;"></video>
            </div>
        </div>

        <div class="loading" id="loadingSection">
            <div class="loading-spinner"></div>
            <p>正在进行检测，请稍候...</p>
        </div>

        <div class="result-section" id="resultSection" style="display: none;">
            <h3>检测结果</h3>
            <div id="resultContent" class="preview-container"></div>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const previewSection = document.getElementById('previewSection');
    const previewImage = document.getElementById('previewImage');
    const previewVideo = document.getElementById('previewVideo');
    const loadingSection = document.getElementById('loadingSection');
    const resultSection = document.getElementById('resultSection');

    // 文件选择事件监听
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            handleFileSelect(e.target.files[0]);
        }
    });

    function handleFileSelect(file) {
        const validImageTypes = ['image/jpeg', 'image/png', 'image/jpg'];
        const validVideoTypes = ['video/mp4', 'video/avi'];

        if (validImageTypes.includes(file.type)) {
            previewImage.style.display = 'block';
            previewVideo.style.display = 'none';
            previewImage.src = URL.createObjectURL(file);
        } else if (validVideoTypes.includes(file.type)) {
            previewImage.style.display = 'none';
            previewVideo.style.display = 'block';
            previewVideo.src = URL.createObjectURL(file);
        } else {
            alert('请上传支持的文件格式！');
            return;
        }

        previewSection.style.display = 'block';
    }

    function startDetection() {
        const formData = new FormData(document.getElementById('uploadForm'));
        const file = fileInput.files[0];
        
        if (!file) {
            handleError('请选择文件');
            return;
        }
        
        console.log('准备上传文件:', file.name);  // 调试信息
        
        loadingSection.style.display = 'block';
        resultSection.style.display = 'none';

        fetch('{% url "detect" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            console.log('服务器响应:', response);  // 调试信息
            return response.json();
        })
        .then(data => {
            console.log('处理结果:', data);  // 调试信息
            loadingSection.style.display = 'none';
            resultSection.style.display = 'block';
            
            if (data.success) {
                resultContent.innerHTML = `
                    <div class="message message-success">
                        <img src="${data.result_image}" alt="检测结果" style="max-width: 100%; height: auto;">
                        <p>${data.message}</p>
                    </div>
                `;
            } else {
                handleError(data.message);
            }
        })
        .catch(error => {
            console.error('上传错误:', error);  // 调试信息
            handleError(error);
        });
    }

    function handleError(error) {
        loadingSection.style.display = 'none';
        resultSection.style.display = 'block';
        resultContent.innerHTML = `
            <div class="message message-error">
                <p>检测过程中出现错误，请重试</p>
                <p>${error}</p>
            </div>
        `;
    }

    function activateCamera() {
        document.getElementById('detection_type').value = 'camera';
        document.getElementById('uploadSection').style.display = 'none';
        document.getElementById('previewSection').style.display = 'none';
        document.getElementById('cameraPreview').style.display = 'block';
        
        // 启动摄像头
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                document.getElementById('webcam').srcObject = stream;
            })
            .catch(err => {
                alert('无法访问摄像头：' + err);
            });
    }

    function activateVideoUpload() {
        document.getElementById('detection_type').value = 'video';
        document.getElementById('cameraPreview').style.display = 'none';
        document.getElementById('uploadSection').style.display = 'block';
        document.getElementById('fileInput').accept = 'video/*';
        document.getElementById('formatHint').textContent = '支持的格式：视频(mp4, avi)';
        // 停止摄像头
        stopCamera();
    }

    function activateImageUpload() {
        document.getElementById('detection_type').value = 'image';
        document.getElementById('cameraPreview').style.display = 'none';
        document.getElementById('uploadSection').style.display = 'block';
        document.getElementById('fileInput').accept = 'image/*';
        document.getElementById('formatHint').textContent = '支持的格式：图片(jpg, png, jpeg)';
        // 停止摄像头
        stopCamera();
    }

    function stopCamera() {
        const video = document.getElementById('webcam');
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
    }

    // 摄像头实时检测
    let cameraInterval;

    function startCameraDetection() {
        const video = document.getElementById('webcam');
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        
        // 设置canvas大小与视频相同
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // 每100ms发送一帧进行检测
        cameraInterval = setInterval(() => {
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frame = canvas.toDataURL('image/jpeg');
            
            // 发送帧到服务器进行检测
            fetch('{% url "detect" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `type=camera&frame=${encodeURIComponent(frame)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 显示检测结果
                    document.getElementById('resultContent').innerHTML = `
                        <img src="${data.result_image}" style="max-width: 100%;">
                    `;
                }
            });
        }, 100);
    }

    function stopCameraDetection() {
        if (cameraInterval) {
            clearInterval(cameraInterval);
        }
    }

    // 修改视频上传处理函数
    function startVideoDetection() {
        const formData = new FormData(document.getElementById('uploadForm'));
        formData.append('type', 'video');
        
        loadingSection.style.display = 'block';
        resultSection.style.display = 'none';
        
        // 显示进度信息
        loadingSection.innerHTML = `
            <div class="loading-spinner"></div>
            <p>正在处理视频：<span id="progressText">0%</span></p>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
        `;
        
        // 设置较长的超时时间
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 300000); // 5分钟超时
        
        fetch('{% url "detect" %}', {
            method: 'POST',
            body: formData,
            signal: controller.signal
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('网络响应错误');
            }
            return response.json();
        })
        .then(data => {
            clearTimeout(timeoutId);
            loadingSection.style.display = 'none';
            resultSection.style.display = 'block';
            
            if (data.success) {
                resultContent.innerHTML = `
                    <video controls style="max-width: 100%;">
                        <source src="${data.result_path}" type="video/mp4">
                    </video>
                    <p>${data.message}</p>
                `;
            } else {
                handleError(data.message);
            }
        })
        .catch(error => {
            clearTimeout(timeoutId);
            if (error.name === 'AbortError') {
                handleError('处理超时，请尝试处理更短的视频');
            } else {
                handleError(error.message);
            }
        });
    }

    // 修改图片上传处理函数
    function startImageDetection() {
        const formData = new FormData(document.getElementById('uploadForm'));
        formData.append('type', 'image');
        
        loadingSection.style.display = 'block';
        resultSection.style.display = 'none';
        
        fetch('{% url "detect" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loadingSection.style.display = 'none';
            resultSection.style.display = 'block';
            
            if (data.success) {
                resultContent.innerHTML = `
                    <img src="${data.result_image}" style="max-width: 100%;">
                    <p>${data.message}</p>
                `;
            } else {
                handleError(data.message);
            }
        })
        .catch(error => handleError(error));
    }

    // 添加错误重试功能
    function retryDetection() {
        resultSection.style.display = 'none';
        startVideoDetection();
    }
</script>
{% endblock %} 